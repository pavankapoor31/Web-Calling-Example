<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bolna AI Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'bolna': {
              50: '#1a1a1a',
              500: '#2d2d2d',
              600: '#1a1a1a',
              700: '#0f0f0f',
              900: '#000000'
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-900 min-h-screen">
  <div class="flex h-screen">
    <!-- Left Sidebar -->
    <div class="w-80 bg-gray-800 shadow-lg border-r border-gray-700 flex flex-col">
      <!-- Sidebar Header -->
      <div class="p-4 border-b border-gray-700">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold text-white">Bolna AI Agents</h2>
          <a href="https://platform.bolna.ai/" target="_blank" class="text-xs text-gray-300 hover:text-white underline">
            Platform
          </a>
        </div>
        <p class="text-sm text-gray-300">Connect and manage your agents</p>
      </div>
      
      <!-- Access Token Section -->
      <div class="p-4 border-b border-gray-700">
        <div class="flex items-center justify-between mb-2">
          <label for="access-token" class="block text-sm font-medium text-gray-300">Access Token</label>
          <a href="https://platform.bolna.ai/developers" target="_blank" class="text-xs text-gray-300 hover:text-white underline">
            Get Token
          </a>
        </div>
        <input type="password" id="access-token" placeholder="Enter your access token" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white text-sm focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent">
        <div class="flex items-center mt-2">
          <input type="checkbox" id="save-token" class="h-4 w-4 text-gray-500 focus:ring-gray-500 border-gray-600 bg-gray-700">
          <label for="save-token" class="ml-2 text-sm text-gray-300">Save token locally</label>
        </div>
        <button id="fetch-agents-btn" class="w-full mt-3 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium transition-colors duration-200">
          Fetch Agents
        </button>
      </div>
      
      <!-- Agents List -->
      <div class="flex-1 overflow-y-auto p-4">
        <div id="agents-list" class="space-y-2">
          <div class="text-center text-gray-400 text-sm py-8">
            <p class="mb-2">Enter your access token and click "Fetch Agents" to load your agents</p>
            <p class="text-xs">
              Need help? Visit the 
              <a href="https://platform.bolna.ai/" target="_blank" class="text-gray-300 hover:text-white underline">Bolna Platform</a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
      <div class="max-w-2xl mx-auto bg-gray-800 shadow-lg overflow-hidden h-full flex flex-col w-full">
    <!-- Header -->
    <div class="bg-gray-900 text-white p-6 text-center">
      <div class="flex items-center justify-center mb-2">
        <div class="w-8 h-8 bg-gray-700 flex items-center justify-center mr-3">
          <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
          </svg>
        </div>
        <h1 class="text-xl font-bold">Bolna AI</h1>
      </div>
      <p class="text-gray-300 text-sm">Voice-powered AI assistant</p>
      <div class="mt-2">
        <a href="https://platform.bolna.ai/" target="_blank" class="text-xs text-gray-400 hover:text-white underline">
          Visit Bolna Platform
        </a>
      </div>
    </div>

    <!-- Current Agent Display -->
    <div class="p-4 border-b border-gray-700 bg-gray-700">
      <div class="flex items-center justify-between">
        <div>
          <label class="block text-xs font-medium text-gray-300 mb-1">Current Agent</label>
          <div id="current-agent-display" class="text-sm text-gray-200">No agent selected</div>
        </div>
        <div class="text-xs text-gray-400">
          <span id="agent-status" class="px-2 py-1 bg-gray-600 text-gray-200">Inactive</span>
        </div>
      </div>
    </div>

    <!-- Chat Area -->
    <div class="flex-1 p-4 overflow-y-auto" id="chat-container">
      <div class="space-y-4">
        <!-- Welcome Message -->
        <div class="flex items-start space-x-3">
          <div class="w-8 h-8 bg-gray-600 flex items-center justify-center flex-shrink-0">
            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="bg-gray-700 p-3 max-w-xs">
            <p class="text-sm text-gray-200">Hi! I'm your Bolna AI assistant. Select an agent from the sidebar and click the call button to start a voice conversation.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Call Controls -->
    <div class="p-4 border-t border-gray-700 bg-gray-700">
      <div class="flex items-center justify-center space-x-4">
        <!-- Call Button -->
        <button id="call-button" class="w-16 h-16 bg-gray-600 hover:bg-gray-500 text-white flex items-center justify-center transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105">
          <svg id="call-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
          </svg>
          <svg id="end-call-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
        </button>
        
        <!-- Status Indicator -->
        <div class="flex items-center space-x-2">
          <div id="status-dot" class="w-3 h-3 bg-gray-500"></div>
          <span id="status-text" class="text-sm text-gray-300">Ready to call</span>
        </div>
      </div>
      
      <!-- Connection Status -->
      <div id="connection-status" class="mt-3 text-center">
        <div class="text-xs text-gray-400">
          <span id="connection-text">Not connected</span>
        </div>
      </div>
    </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/gh/bolna-ai/web-call@v1.0.2/bolna-webcall-library.min.js"></script>
  
  <script>
    // Configuration - you can hardcode these or use prompts
    const CONFIG = {
      agentId: 'your-agent-id-here', // Replace with your actual agent ID
      accessToken: 'your-access-token-here', // Replace with your actual access token
      websocketHost: 'wss://ws.bolna.ai',
      enableMicInterruptions:true,
      queueProcessingInterval: 50, // Default 50ms
      onMediaPermissionGranted:()=>{
        console.log("callback on media permissions given")
      }
    };

    // DOM elements
    const accessTokenInput = document.getElementById('access-token');
    const saveTokenCheckbox = document.getElementById('save-token');
    const fetchAgentsBtn = document.getElementById('fetch-agents-btn');
    const queueIntervalSelect = 50;
    const agentsList = document.getElementById('agents-list');
    const currentAgentDisplay = document.getElementById('current-agent-display');
    const agentStatus = document.getElementById('agent-status');
    const callButton = document.getElementById('call-button');
    const callIcon = document.getElementById('call-icon');
    const endCallIcon = document.getElementById('end-call-icon');
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const connectionText = document.getElementById('connection-text');
    const chatContainer = document.getElementById('chat-container');

    // State
    let webCalling = null;
    let isCallActive = false;
    let isConnected = false;
    let currentAgent = null;
    let agents = [];

    // Save/load access token from localStorage
    function saveAccessToken() {
      if (saveTokenCheckbox.checked) {
        localStorage.setItem('bolna_access_token', accessTokenInput.value);
        localStorage.setItem('bolna_save_token', 'true');
      } else {
        localStorage.removeItem('bolna_access_token');
        localStorage.removeItem('bolna_save_token');
      }
    }

    function loadAccessToken() {
      const savedToken = localStorage.getItem('bolna_access_token');
      const shouldSave = localStorage.getItem('bolna_save_token') === 'true';
      
      if (savedToken && shouldSave) {
        accessTokenInput.value = savedToken;
        saveTokenCheckbox.checked = true;
      }
    }

    // Fetch agents from Bolna API
    async function fetchAgents() {
      const accessToken = accessTokenInput.value.trim();
      
      if (!accessToken) {
        showMessage('Please enter your access token first', 'error');
        return;
      }

      // Save token if checkbox is checked
      saveAccessToken();

      try {
        fetchAgentsBtn.textContent = 'Loading...';
        fetchAgentsBtn.disabled = true;

        const response = await fetch('https://api.bolna.ai/v2/agent/all', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        agents = data;
        displayAgents(data);
        showMessage(`Successfully loaded ${data.length} agents`, 'system');

      } catch (error) {
        console.error('Error fetching agents:', error);
        showMessage(`Error fetching agents: ${error.message}`, 'error');
        agentsList.innerHTML = '<div class="text-center text-red-400 text-sm py-8">Failed to load agents</div>';
      } finally {
        fetchAgentsBtn.textContent = 'Fetch Agents';
        fetchAgentsBtn.disabled = false;
      }
    }

    // Display agents in the sidebar
    function displayAgents(agentsData) {
      if (agentsData.length === 0) {
        agentsList.innerHTML = '<div class="text-center text-gray-400 text-sm py-8">No agents found</div>';
        return;
      }

      agentsList.innerHTML = agentsData.map(agent => `
        <div class="border border-gray-600 p-3 hover:bg-gray-700 transition-colors">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-medium text-sm text-white">${agent.agent_name}</h3>
            <span class="px-2 py-1 text-xs ${agent.agent_status === 'processed' ? 'bg-green-600 text-green-200' : 'bg-yellow-600 text-yellow-200'}">
              ${agent.agent_status}
            </span>
          </div>
          <p class="text-xs text-gray-400 mb-3">ID: ${agent.id.substring(0, 8)}...</p>
          <button 
            onclick="selectAgent('${agent.id}', '${agent.agent_name}')" 
            class="w-full px-3 py-2 bg-gray-600 hover:bg-gray-500 text-white text-sm font-medium transition-colors duration-200"
          >
            Talk with ${agent.agent_name}
          </button>
        </div>
      `).join('');
    }

    // Select an agent
    function selectAgent(agentId, agentName) {
      currentAgent = { id: agentId, name: agentName };
      currentAgentDisplay.textContent = agentName;
      agentStatus.textContent = 'Ready';
      agentStatus.className = 'px-2 py-1 bg-green-600 text-green-200 text-xs';
      showMessage(`Selected agent: ${agentName}`, 'system');
    }

    // Initialize WebCalling instance
    function initializeWebCalling() {
      if (webCalling && webCalling.isCallActive()) {
        return webCalling;
      }

      if (!currentAgent) {
        showMessage('Please select an agent first', 'error');
        return null;
      }

      const accessToken = accessTokenInput.value.trim();
      
      if (!accessToken) {
        showMessage('Please enter your access token', 'error');
        return null;
      }

        webCalling = new BolnaWebCalling({
        agentId: currentAgent.id,
        accessToken: accessToken,
        websocketHost: CONFIG.websocketHost,
        enableMicInterruptions:CONFIG.enableMicInterruptions,
        queueProcessingInterval: parseInt(queueIntervalSelect.value),
        contextData: {},
          
        onCallStateChange: (active) => {
          isCallActive = active;
          updateUI();
          if (active) {
            showMessage('Call started! You can now speak to the AI assistant.', 'system');
          } else {
            showMessage('Call ended.', 'system');
          }
        },
        
          onFirstAudioPacket: () => {
          isConnected = true;
          updateUI();
          showMessage('Connected! AI is ready to respond.', 'system');
          },
        
          onError: (type, error) => {
          // console.error('Bolna Error:', type, error);
          // showMessage(`Error: ${error.message || 'Unknown error occurred'}`, 'error');
          // isCallActive = false;
          // isConnected = false;
          // updateUI();
        },
        
        onMediaPermissionGranted: CONFIG.onMediaPermissionGranted
      });

      return webCalling;
    }
    
    // Update UI based on call state
    function updateUI() {
      if (isCallActive) {
        if (isConnected) {
          // Call is active and connected
          callButton.className = 'w-16 h-16 bg-red-600 hover:bg-red-700 text-white flex items-center justify-center transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105';
          callIcon.classList.add('hidden');
          endCallIcon.classList.remove('hidden');
          statusDot.className = 'w-3 h-3 bg-green-500 animate-pulse';
          statusText.textContent = 'Connected';
          connectionText.textContent = 'AI is listening...';
        } else {
          // Call is active but connecting
          callButton.className = 'w-16 h-16 bg-yellow-600 hover:bg-yellow-700 text-white flex items-center justify-center transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105';
          callIcon.classList.add('hidden');
          endCallIcon.classList.remove('hidden');
          statusDot.className = 'w-3 h-3 bg-yellow-500 animate-pulse';
          statusText.textContent = 'Connecting...';
          connectionText.textContent = 'Establishing connection...';
        }
      } else {
        // Call is not active
        callButton.className = 'w-16 h-16 bg-gray-600 hover:bg-gray-500 text-white flex items-center justify-center transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105';
        callIcon.classList.remove('hidden');
        endCallIcon.classList.add('hidden');
        statusDot.className = 'w-3 h-3 bg-gray-500';
        statusText.textContent = 'Ready to call';
        connectionText.textContent = 'Not connected';
      }
    }

    // Show message in chat
    function showMessage(text, type = 'system') {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex items-start space-x-3';
      
      const iconDiv = document.createElement('div');
      iconDiv.className = 'w-8 h-8 flex items-center justify-center flex-shrink-0';
      
      const messageContent = document.createElement('div');
      messageContent.className = 'p-3 max-w-xs';
      
      if (type === 'system') {
        iconDiv.className += ' bg-gray-600';
        iconDiv.innerHTML = '<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/></svg>';
        messageContent.className += ' bg-gray-700';
        messageContent.innerHTML = `<p class="text-sm text-gray-200">${text}</p>`;
      } else if (type === 'error') {
        iconDiv.className += ' bg-red-600';
        iconDiv.innerHTML = '<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>';
        messageContent.className += ' bg-red-700';
        messageContent.innerHTML = `<p class="text-sm text-red-200">${text}</p>`;
      }
      
      messageDiv.appendChild(iconDiv);
      messageDiv.appendChild(messageContent);
      
      chatContainer.querySelector('.space-y-4').appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Handle checkbox change
    saveTokenCheckbox.addEventListener('change', saveAccessToken);

    // Handle fetch agents button click
    fetchAgentsBtn.addEventListener('click', fetchAgents);

    // Handle call button click
    callButton.addEventListener('click', () => {
      if (isCallActive) {
        // End call
        if (webCalling) {
        webCalling.endWebCall();
        }
      } else {
        // Start call
        const instance = initializeWebCalling();
        if (instance) {
          instance.initiateWebCall();
        }
      }
    });

    // Make selectAgent function global so it can be called from onclick
    window.selectAgent = selectAgent;

    // Initialize UI and load saved token
    loadAccessToken();
    updateUI();
  </script>
</body>
</html>